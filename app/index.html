<!doctype html>
<html class="no-js">
  <head>
    <meta charset="utf-8">
    <meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
    <title>Saco: Inkomstjämföraren</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="shortcut icon" href="/favicon.ico">
    <!-- Place favicon.ico and apple-touch-icon.png in the root directory -->
    <!-- build:css(.) styles/vendor.css -->
    <!-- bower:css -->
    <link rel="stylesheet" href="bower_components/hopscotch/dist/css/hopscotch.css" />
    <!-- endbower -->
    <!-- endbuild -->
    <!-- build:css(.tmp) styles/main.css -->
    <link rel="stylesheet" href="styles/main.css">
    <!-- endbuild -->
  </head>
  <body>
    <!--[if lt IE 10]>
      <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->

    <div class="container">
      <div id="ui">
        Jag har en månadslön på <input type="text" size="6" id="income" placeholder="" value="35000"/>
        kronor och jobbar som 
        <select id="profession">
          <option value="">Välj yrke</option>
        </select>
        inom
        <select id="publicprivate">
          <option value="public">offentlig sektor</option>
          <option value="private">privat sektor</option>
        </select>
        . Hur står sig min lön?
      </div>
      <div id="chart"></div>
    </div>

<!-- Saco typography -->
<script type="text/javascript" src="//use.typekit.net/zxg8sjd.js"></script>
<script type="text/javascript">try { Typekit.load(); } catch (e) { console.log(e); }</script>


    <!-- build:js(.) scripts/vendor.js -->
    <!-- bower:js -->
    <script src="bower_components/d3/d3.js"></script>
    <script src="bower_components/pym.js/dist/pym.js"></script>
    <script src="bower_components/d3-tip/index.js"></script>
    <script src="bower_components/hopscotch/dist/js/hopscotch.js"></script>
    <!-- endbower -->
    <!-- endbuild -->


        <!-- build:js({app,.tmp}) scripts/main.js -->
        <script src="scripts/chart.js"></script>
        <script src="scripts/formats.js"></script>
        <!-- endbuild -->

    <script>
    function columnFormats(d) {
      d.value = +d.value.replace(",",".");
      return d;
    }
    function getZeroData(data) {
      var incomeGroups = d3.set(data.map(function(d) { return d.income; }))
        .values()
        .sort();

      return incomeGroups.map(function(d) {
        return {
          income: d,
          incomeLower: +d.split("-")[0],
          incomeUpper: +d.split("-")[1],
          value: 0,
          publicprivate: null,
          profession: null,
        }
      })
    }
    function getCurrentData(data) {
      var profession = elemProfession.node().value;
      var publicprivate = elemPublicPrivate.node().value;

      if (profession == null) {
        return getZeroData(data);
      }
      return data.filter(function(d) {
        return (d.profession == profession && d.publicprivate == publicprivate);
      })
    }
    function validProfessionSelection() {
      return elemProfession.node().value !== "";
    }
    function validIncomeInput() {
      var income = elemIncome.node().value.trim();
      return !isNaN(income);
    }
    var chartSelector = "#chart";
    var elemProfession = d3.select("#profession");
    var elemIncome = d3.select("#income");
    var elemPublicPrivate = d3.select("#publicprivate");
    var elemChart = d3.select(chartSelector);

    // Enable iframe resonsiveness
    var isIframe = self !== top;
    if (isIframe) {
        var pymChild = new pym.Child();
        pymChild.sendHeight();
    }

    d3.csv("data/data.csv", columnFormats, function(error, data) {
      if (error) throw error;

      // Fetch upper and lower boundry of income group
      data = data.map(function(d) {
        d.incomeLower = +d.income.split("-")[0];
        d.incomeUpper = +d.income.split("-")[1];
        return d;
      })
      
      // Build UI
      var professions = d3.set(data.map(function(d) { return d.profession; }))
        .values()
        .sort();

      elemProfession.selectAll("option")
        .data(professions, function(d) { return d; })
        .enter()
        .append("option")
        .attr("value", function(d) { return d; })
        .text(function(d) { return d.toLowerCase(); });

      // Init visualiztion
      var currentData = getZeroData(data);
      var currentIncome = +elemIncome.node().value;
      var opts = {
        yMax: d3.max(data.map(function(d) { return d.value })),
        isIframe: isIframe
      };
      var chart = new IncomeChart(chartSelector, currentData, currentIncome, opts)
      
      elemChart.classed("invalid-profession", !validProfessionSelection());
      elemChart.classed("invalid-income", !validIncomeInput());


      // Update chart when UI changes
      d3.selectAll("#publicprivate, #profession").on("change", function() {
        var validProfession = validProfessionSelection();
        elemChart.classed("invalid-profession", !validProfession);
        if (validProfession) {
          var currentData = getCurrentData(data);
          chart.updateData(currentData);          
        }
      })

      elemIncome.on("keyup", function() {
        var validIncome = validIncomeInput();
        elemChart.classed("invalid-income", !validIncome);

        if (validIncome) {
          var currentIncome = +elemIncome.node().value;
          chart.updateIncomeLine(currentIncome);          
        }
      })

      elemProfession.node().value = "Bibliotekarie";
      d3.selectAll("#publicprivate, #profession").on("change")();
      elemIncome.on("keyup")();


      // First define your tour.
      var tour = {
        "id": "hopscotch",
        "steps": [
          {
            "target": "income",
            "placement": "bottom",
            "title": "Ange din lön här",
            "content": ""
          },/*
          {
            "target": "profession",
            "placement": "bottom",
            "title": "Ditt yrke",
            "content": ""
          }
          {
            "target": "publicprivate",
            "placement": "bottom",
            "title": "Och om du jobbar privat eller offentligt",
            "content": ""
          }*/
        ]
      };

      // Then start the tour.
      hopscotch.startTour(tour);
    })
    </script>
</body>
</html>
